---
import Layout from "../../layouts/Layout.astro";
import LoginModal from "../../components/Login-Modal.astro";

import {getPostInfo } from "../../lib/wp.js";

const slug = Astro.params.slug;
if (!slug) throw new Error("/404");
const posts = await getPostInfo(slug);
const date = posts[0];
const rawDetails = Array.isArray(date.attributeDetails) ? date.attributeDetails : [];
const detailsText = rawDetails.join('\n');
const modules = detailsText
  .split('\n')
  .map((s : any) => s.trim())
  .filter(Boolean);
const totalModulos = modules.length; 
const descripcionCorta = date.short_description;
const descripcionLarga = date.description;
---

<Layout
  title={date.name}
  description="Pagina de todos los cursos que se encuentran disponibles"
>



  <section class="bg-white p-10 md:p-10 relative">
    <div class="max-w-[1300px] flex flex-col md:flex-row gap-4 m-auto">
      <div class="flex flex-col-reverse md:flex-row gap-4">
        <ul
        id="thumbnailList"
        class="flex flex-row md:flex-col overflow-x-auto md:overflow-y-auto md:overflow-x-hidden rounded-lg gap-2 md:h-[55vh] md:w-[150px] scroll-hidden"
      >
        {date.imageSrcs.map((src: any) => (
          <li class="flex-shrink-0">
            <img
              class="thumbnail w-[80px] md:w-[150px] h-[80px] md:h-[100px] object-fill rounded cursor-pointer"
              src={src}
              alt=""
              data-full={src}
            />
          </li>
        ))}
      </ul>
        
      <div
        class="w-full min-w-[300px] md:w-[600px] h-[30vh] md:h-[55vh] overflow-hidden rounded-lg bg-white cursor-pointer"
        id="imageContainer"
      >
        <img
          id="mainImage"
          class="w-full h-full object-fill hover:opacity-90 transition"
          src={date.imageSrcs[0]}
          alt=""
        />
      </div>
      </div>
      <!-- Modal -->
      <div
        id="modal"
        class="hidden fixed inset-0 z-50 bg-black/80 justify-center items-center"
        >
        <!-- Botón cerrar -->
        <button
          id="closeModalBtn"
          class="absolute top-4 right-6 text-white text-5xl font-bold hover:text-gray-300 transition"
        >
          ×
        </button>

        <!-- Imagen ampliada -->
        <img
          id="modal-img"
          class="max-w-[90vw] max-h-[80vh] object-contain rounded-lg shadow-lg"
          alt="Imagen ampliada"
        />
      </div>

      <div class="space-y-3">
        <h3 class="font-bold">
          {date.name}
        </h3>
        <div class="flex gap-2">
          <span class="line-through text-gray-400 text-2xl">
            $. {parseFloat(date.regular_price).toFixed(2)}
          </span>
          <span class="text-gray-900 font-semibold text-2xl">
            $. {parseFloat(date.price).toFixed(2)}
          </span> 
        </div>
        <div class="prose prose-neutral max-w-none" set:html={descripcionCorta}></div>
        <div class="md:flex gap-5 space-y-5 md:space-y-0 ">
          <button
            type="button"
            class="add-buy-now w-full py-2.5 px-5 text-sm focus:outline-none bg-white rounded-lg border border-black hover:bg-black hover:text-white focus:z-10 focus:ring-4 focus:ring-gray-100"
            data-curso={JSON.stringify({ id: date.id })}>
            Comprar ahora
          </button>
          <button
          type="button"
          class="btn-add-cart w-full py-2.5 px-5 text-sm focus:outline-none bg-white rounded-lg border border-black hover:bg-black hover:text-white focus:z-10 focus:ring-4 focus:ring-gray-100"
          data-id={date.id}
        >
          Agregar al carrito
        </button>
        
        </div>
        
        <div class="mt-6">
          <span class="text-lg font-bold text-gray-700">Paga mediante:</span>
          <div class="flex items-center justify-between ">
            <div class="w-[50px] md:w-[80px]">
              <img src="../../img/mc.svg" alt="">
            </div>
            <div class="w-[50px] md:w-[80px] my-0">
              <img src="../../img/visa.svg" alt="">
            </div>
            <div class="w-[70px] md:w-[130px] my-0">
              <img src="../../img/paypal1.svg" alt="">
            </div>
            <div class="w-[70px] md:w-[130px] my-0">
              <img src="../../img/binance.svg" alt="">
            </div>
          </div>
        </div>
        
      </div>
    </div>
  </section>
  
  <section class="bg-white px-10 md:px-10 relative">
    <div class="max-w-[1300px] m-auto">
      <div class="border-b border-gray-100">
        <ul
          class="flex flex-wrap -mb-px text-sm font-medium text-center text-gray-500 dark:text-gray-400"
          id="tabs"
        >
          <li class="me-2">
            <button
              data-tab="descripcion"
              class="tab-btn inline-flex items-center justify-center p-4 text-blue-600 border-b-2 border-blue-600 rounded-t-lg hover:text-gray-600 hover:border-gray-300"
            >
              Descripción
            </button>
          </li>
          <li class="me-2">
            <button
              data-tab="temario"
              class="tab-btn inline-flex items-center justify-center p-4 border-b-2 border-transparent rounded-t-lg hover:text-gray-600 hover:border-gray-300"
            >
              Temario
            </button>
          </li>
          <!-- <li class="me-2">
            <button
              data-tab="opiniones"
              class="tab-btn inline-flex items-center justify-center p-4 border-b-2 border-transparent rounded-t-lg hover:text-gray-600 hover:border-gray-300"
            >
              Opiniones
            </button>
          </li> -->
        </ul>
      </div>
      <!-- Contenedores de contenido -->
      <div class="py-10">
        <div
          id="descripcion"
          class="tab-content flex bg-black/5 rounded-sm text-black " 
        >
          <div class="p-7 space-y-5">
            <div class="prose prose-neutral max-w-none" set:html={descripcionLarga}></div>
          </div>
        </div>
        <div id="temario" class="tab-content w-full bg-black/5 rounded-sm text-black hidden">
          <div class="p-7 space-y-5">
            <h3 class="font-bold">Temario del curso</h3>
            <p>{totalModulos} Módulos</p>
        
            {modules.map((titulo : any, i : any) => {
              const idx = i + 1;
              return (
                <div class="border border-slate-200 p-3 bg-white rounded-sm" id={`acc-${idx}`}>
                  <button
                    type="button"
                    onclick={`toggleAccordion(${idx});`}
                    class="text-start w-full flex justify-between items-center text-slate-800"
                  >
                    <span>{titulo}</span>
                    <span id={`icon-${idx}`} class="text-slate-800 transition-transform duration-300">
                      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" class="w-4 h-4">
                        <path d="M8.75 3.75a.75.75 0 0 0-1.5 0v3.5h-3.5a.75.75 0 0 0 0 1.5h3.5v3.5a.75.75 0 0 0 1.5 0v-3.5h3.5a.75.75 0 0 0 0-1.5h-3.5v-3.5Z" />
                      </svg>
                    </span>
                  </button>
                  <div id={`content-${idx}`} class="max-h-0 overflow-hidden transition-all duration-300 ease-in-out">
                    <div class="pb-5 text-sm text-slate-500 mt-5">
                      Contenido privado, disponible solo para nuestro clientes.
                    </div>
                  </div>
                </div>
              );
            })}
          </div>
        </div>
        

        <div id="opiniones" class="tab-content hidden">
          <p>Aquí van las opiniones de los estudiantes.</p>
        </div>
      </div>
    </div>
  </section>
    <!-- contenido del modal -->
    <LoginModal/>
  
    
    <script>
      import { setupAddToCart } from "/src/scripts/add-to-cart.ts";
      setupAddToCart(".btn-add-cart");
    </script>
    
    <script>
      // ✅ Función para comprar ahora
      function buyNow(productId, quantity = 1) {
        window.location.href = `https://vip.bovedadecursos2025.com/?buy_now=${productId}&qty=1`;
      }
    
      // ✅ Detectar clic en el botón y obtener el ID del curso
      document.querySelectorAll('.add-buy-now').forEach((button) => {
        button.addEventListener('click', () => {
          const curso = JSON.parse(button.getAttribute('data-curso'));
          if (curso && curso.id) {
            buyNow(curso.id); // Llama a checkout directo
          } else {
            console.error('❌ No se encontró el ID del curso');
          }
        });
      });
    </script>
 
</Layout>

<style>
  .scroll-hidden::-webkit-scrollbar {
  display: none;
}

.scroll-hidden {
  -ms-overflow-style: none; /* IE y Edge */
  scrollbar-width: none; /* Firefox */
}
</style>

<script is:inline>
  const plusSVG = `
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" class="w-4 h-4">
      <path d="M8.75 3.75a.75.75 0 0 0-1.5 0v3.5h-3.5a.75.75 0 0 0 0 1.5h3.5v3.5a.75.75 0 0 0 1.5 0v-3.5h3.5a.75.75 0 0 0 0-1.5h-3.5v-3.5Z" />
    </svg>
  `;

  const minusSVG = `
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" class="w-4 h-4">
      <path d="M3.75 7.25a.75.75 0 0 0 0 1.5h8.5a.75.75 0 0 0 0-1.5h-8.5Z" />
    </svg>
  `;

  function toggleAccordion(index) {
    const currentContent = document.getElementById(`content-${index}`);
    const currentIcon = document.getElementById(`icon-${index}`);
    const isOpen = currentContent.style.maxHeight && currentContent.style.maxHeight !== '0px';

    // Cerrar todos
    document.querySelectorAll('[id^="content-"]').forEach(content => {
      content.style.maxHeight = '0';
    });

    document.querySelectorAll('[id^="icon-"]').forEach(icon => {
      icon.innerHTML = plusSVG;
    });

    // Abrir solo si estaba cerrado
    if (!isOpen) {
      currentContent.style.maxHeight = currentContent.scrollHeight + 'px';
      currentIcon.innerHTML = minusSVG;
    }
  }
</script>


<script>
  const tabButtons = document.querySelectorAll(".tab-btn");
  const tabContents = document.querySelectorAll(".tab-content");

  tabButtons.forEach((button) => {
    button.addEventListener("click", () => {
      const tabId = button.getAttribute("data-tab")!;

      // Quitar clases activas a todos los botones
      tabButtons.forEach((btn) => {
        btn.classList.remove(
          "text-blue-600",
          "border-blue-600",
          "dark:text-blue-500",
          "dark:border-blue-500",
        );
        btn.classList.add("text-gray-500", "border-transparent");
      });

      // Ocultar todo el contenido
      tabContents.forEach((content) => {
        content.classList.add("hidden");
      });

      // Activar el botón actual
      button.classList.add("text-blue-600", "border-blue-600");
      button.classList.remove("text-gray-500", "border-transparent");

      // Mostrar contenido relacionado
      document.getElementById(tabId)!.classList.remove("hidden");
    });
  });
</script>

<script class="">
  (() => {
    const thumbnails = document.querySelectorAll(".thumbnail");
    const mainImage = document.querySelector("#mainImage");
  
    function updateActiveThumbnail(activeSrc) {
      thumbnails.forEach((thumb) => {
        const thumbEl = thumb;
        const thumbSrc = thumbEl.getAttribute("data-full");
  
        if (thumbSrc === activeSrc) {
          thumbEl.classList.remove("opacity-50");
          thumbEl.classList.add("opacity-100");
        } else {
          thumbEl.classList.add("opacity-50");
          thumbEl.classList.remove("opacity-100");
        }
      });
    }
  
    thumbnails.forEach((thumb) => {
      thumb.addEventListener("click", () => {
        const newSrc = thumb.getAttribute("data-full");
        mainImage.src = newSrc;
        updateActiveThumbnail(newSrc);
      });
    });
  
    updateActiveThumbnail(mainImage.src);
  })();
  </script>


<script is:inline>
  document.addEventListener('visibilitychange', () => {
    if (document.visibilityState === 'visible') {
      // Si vuelve visible tras salir del checkout, podemos refrescar en caliente:
      const nav = performance.getEntriesByType?.('navigation')?.[0];
      if (nav && nav.type === 'back_forward') {
        // ya cubierto por pageshow, pero esto cubre algunos Safari raros
        // refreshSilently(); // <- descomenta si lo deseas
      }
    }
  });
  </script>


<script class="">
  const imageContainer = document.getElementById('imageContainer');
  const mainImage = document.getElementById('mainImage');
  const modal = document.getElementById('modal');
  const modalImg = document.getElementById('modal-img');
  const closeModalBtn = document.getElementById('closeModalBtn');

  // Mostrar modal al hacer clic en la imagen
  imageContainer.addEventListener('click', () => {
    modal.classList.remove('hidden');
    modal.classList.add('flex');
    modalImg.src = mainImage.src;
  });

  // Función para cerrar modal
  const closeModal = () => {
    modal.classList.remove('flex');
    modal.classList.add('hidden');
    modalImg.src = '';
  };

  // Cerrar con la X
  closeModalBtn.addEventListener('click', closeModal);

  // Cerrar al hacer clic fuera de la imagen
  modal.addEventListener('click', (e) => {
    if (e.target === modal) closeModal();
  });
</script>
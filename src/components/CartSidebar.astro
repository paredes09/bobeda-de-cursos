---
import Shopping_cart from "./icons/Shopping-cart.astro";
---
<div id="overlay"
  class="hidden fixed inset-0 bg-black/40 z-[90] "
  onclick="closeCart();"></div>

<!-- Sidebar del carrito -->
<div id="cartSidebar"
  class="fixed top-0 right-0 h-full w-72 md:w-96 bg-white shadow-xl translate-x-full transition-transform duration-300 z-[100] flex flex-col">

  <!-- BotÃ³n cerrar -->
  <div class="flex justify-end items-center p-4 border-b border-gray-200">
    <button 
      onclick="closeCart();" 
      class="text-gray-400 hover:text-red-500 transition-all duration-200 text-2xl font-light"
      aria-label="Cerrar carrito">
      âœ–
    </button>
  </div>

  <!-- Contenedor que ocupa todo el espacio restante -->
  <div class="flex flex-col flex-grow overflow-y-auto p-4 gap-2" id="cartItems">
    <p class="text-gray-500">Cargando carrito...</p>
  </div>

  <!-- Acciones fijas abajo -->
  <div id="cartActions" class="sticky bottom-0 left-0 w-full p-4 bg-white border-t border-gray-200 hidden">
    <button 
      onclick="window.location.href='https://vip.bovedadecursos2025.com/carrito/';"
      class="w-full py-2 mb-2 text-sm font-semibold text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-lg transition">
      Ver carrito
    </button>

    <button 
      onclick="window.location.href='https://vip.bovedadecursos2025.com/carrito/finalizar-compra';"
      class="w-full py-2 text-sm font-semibold text-white bg-blue-600 hover:bg-blue-700 rounded-lg transition">
      Finalizar compra
    </button>
  </div>
</div>

<!-- BotÃ³n global de abrir -->
<button id="cartBtn"
  class="relative text-gray-700 hover:text-black"
  onclick="openCart()">
  <Shopping_cart class="size-8 inline-block" />
  
  <!-- Burbuja con nÃºmero centrado -->
  <span id="cart-count"
      class="absolute -top-2 -right-2 bg-red-600 text-white text-xs font-bold w-5 h-5 rounded-full hidden"
    >
    4
    </span>

</button>


  
<!-- Scripts embebidos -->
<script class="">
  
  import { getCart, deleteCartItem  } from "../lib/wp.ts";

  let cartItems = [];

  // âœ… Cargar carrito en el cliente apenas se abre la pÃ¡gina
  async function loadCart() {
    try {
      cartItems = await getCart(); // Llamada fetch al backend
      renderCartItems();
      updateCartBadge();
    } catch (error) {
      document.getElementById("cartItems").innerHTML =
        '<p class="text-gray-500 pt-5">Error al cargar el carrito.</p>';
    }
  }

  // âœ… Renderizar productos dentro del sidebar
  function renderCartItems() {
    const container = document.getElementById("cartItems");
    const cartActions = document.getElementById("cartActions");
    container.innerHTML = ""; // limpiar contenido

    if (!cartItems || cartItems.length === 0) {
      container.innerHTML = '<p class="text-gray-500 pt-5">Aun no hay productos en su carrito de compras</p>';
      cartActions.classList.add("hidden");
      return;
    }

    cartActions.classList.remove("hidden");

    cartItems.forEach((item) => {
      container.innerHTML += `
        <div class="flex items-center gap-3 p-3 rounded-xl shadow-md bg-white hover:shadow-lg transition-all relative">
          <img 
            src="${item.imageSrc}" 
            alt="${item.name}" 
            class="w-14 h-14 md:w-16 md:h-16 object-cover rounded-lg"
          />  
          <div class="flex-1">
            <p class="text-sm md:text-base font-semibold text-gray-700 leading-tight">${item.name}</p>
            <p class="text-xs md:text-sm text-gray-500">Cantidad: 
              <span class="font-bold text-gray-700">${item.quantity}</span>
            </p>
          </div>

          <!-- BotÃ³n eliminar -->
          <button 
            class="absolute top-2 right-3 text-gray-400 hover:text-red-500 transition text-xl font-bold delete-btn"
            data-key="${item.key}"
            title="Eliminar del carrito"
          >
            Ã—
          </button>
        </div>
      `;
    });

    document.querySelectorAll(".delete-btn").forEach((btn) => {
      btn.addEventListener("click", async (e) => {
        const key = btn.getAttribute("data-key");
        btn.disabled = true;
        btn.textContent = "â€¦";

        try {
          await deleteCartItem(key);
          await loadCart(); // ðŸ”„ recargar carrito tras borrar
        } catch (error) {
          console.error("Error eliminando del carrito:", error);
          alert("No se pudo eliminar el producto. Intente nuevamente.");
        } finally {
          btn.disabled = false;
          btn.textContent = "x";
        }
      });
    });
  }

  // âœ… Actualiza la burbuja del Ã­cono del carrito
  function updateCartBadge() {
    const badge = document.getElementById("cart-count");
    if (cartItems.length > 0) {
      badge.textContent = cartItems.length;
      badge.classList.remove("hidden");
      badge.classList.add("flex", "items-center", "justify-center");
    } else {
      badge.classList.add("hidden");
      badge.classList.remove("flex", "items-center", "justify-center");
    }
  }
  
  window.addEventListener("cart-updated", () => {
    loadCart();            // ðŸ”„ Recargar carrito
  });

  // âœ… Ejecutamos al cargar la pÃ¡gina
  loadCart();

  // âœ… Funciones para abrir y cerrar el carrito
  window.openCart = () => {
    document.getElementById('cartSidebar')?.classList.remove('translate-x-full');
    document.getElementById('overlay')?.classList.remove('hidden');
  };

  window.closeCart = () => {
    document.getElementById('cartSidebar')?.classList.add('translate-x-full');
    document.getElementById('overlay')?.classList.add('hidden');
  }; 
</script>

